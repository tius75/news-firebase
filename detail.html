<!DOCTYPE html>
<html lang="id">
<head>
    <!-- ... (keep all existing head content) ... -->
</head>
<body>
    <!-- ... (keep all existing body content) ... -->

    <script>
        // --- GLOBAL SPEECH SYNTHESIS VARIABLES ---
        const synth = window.speechSynthesis;
        let currentUtterance = null;
        let isSpeaking = false;
        let voicesLoaded = false;

        // --- FUNGSI UTILITY ---
        function getFirstImageFromContent(htmlContent) {
            if (!htmlContent) return null;
            const match = htmlContent.match(/<img[^>]+src="([^">]+)"/);
            return match ? match[1] : null;
        }

        function removeFirstImageTag(htmlContent) {
            if (!htmlContent) return htmlContent;
            return htmlContent.replace(/<img[^>]*?>/, '');
        }
        
        function stripHtml(html) {
            let doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        }

        // Improved text normalization for speech
        function normalizeTextForSpeech(text) {
            // Handle acronyms (2+ uppercase letters together) - pronounce as words
            text = text.replace(/\b([A-Z]{2,})\b/g, (match) => {
                // Common acronyms that should be pronounced as words
                const acronyms = {
                    'NASA': 'nasa',
                    'UNICEF': 'unicef',
                    'UNESCO': 'unesco',
                    'ASEAN': 'asean'
                    // Add more acronyms as needed
                };
                return acronyms[match] || match.toLowerCase();
            });

            // Handle years (4-digit numbers)
            text = text.replace(/\b(19|20)\d{2}\b/g, (match) => {
                // Convert year to spoken form (e.g., "2025" -> "dua ribu dua puluh lima")
                const year = parseInt(match);
                if (year >= 2000) {
                    const thousands = Math.floor(year / 1000);
                    const remainder = year % 1000;
                    return `${numberToWords(thousands)} ribu${remainder > 0 ? ' ' + numberToWords(remainder) : ''}`;
                } else {
                    return numberToWords(year);
                }
            });

            // Handle numbers
            text = text.replace(/\b\d+\b/g, (match) => {
                return numberToWords(parseInt(match));
            });

            return text;
        }

        // Helper function to convert numbers to Indonesian words
        function numberToWords(num) {
            const ones = ['', 'satu', 'dua', 'tiga', 'empat', 'lima', 'enam', 'tujuh', 'delapan', 'sembilan'];
            const teens = ['sepuluh', 'sebelas', 'dua belas', 'tiga belas', 'empat belas', 'lima belas', 
                          'enam belas', 'tujuh belas', 'delapan belas', 'sembilan belas'];
            const tens = ['', 'sepuluh', 'dua puluh', 'tiga puluh', 'empat puluh', 'lima puluh', 
                         'enam puluh', 'tujuh puluh', 'delapan puluh', 'sembilan puluh'];
            
            if (num === 0) return 'nol';
            if (num < 10) return ones[num];
            if (num < 20) return teens[num - 10];
            if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + ones[num % 10] : '');
            if (num < 200) return 'seratus' + (num % 100 !== 0 ? ' ' + numberToWords(num % 100) : '');
            if (num < 1000) return ones[Math.floor(num / 100)] + ' ratus' + (num % 100 !== 0 ? ' ' + numberToWords(num % 100) : '');
            if (num < 2000) return 'seribu' + (num % 1000 !== 0 ? ' ' + numberToWords(num % 1000) : '');
            if (num < 1000000) return numberToWords(Math.floor(num / 1000)) + ' ribu' + (num % 1000 !== 0 ? ' ' + numberToWords(num % 1000) : '');
            if (num < 1000000000) return numberToWords(Math.floor(num / 1000000)) + ' juta' + (num % 1000000 !== 0 ? ' ' + numberToWords(num % 1000000) : '');
            return num.toString();
        }

        // --- FUNGSI TEXT-TO-SPEECH (IMPROVED) ---
        function toggleSpeech() {
            const articleContentElement = document.querySelector('.article-content');
            const ttsBtnIcon = document.querySelector('#text-to-speech-btn i');

            if (!articleContentElement) {
                console.error("Article content element not found.");
                return;
            }

            // If speech is currently ongoing, stop it
            if (synth.speaking) {
                synth.cancel();
                isSpeaking = false;
                ttsBtnIcon.classList.remove('fa-volume-mute');
                ttsBtnIcon.classList.add('fa-volume-up');
                return;
            }

            // Prepare the text to speak
            let textToSpeak = stripHtml(articleContentElement.innerHTML);
            textToSpeak = normalizeTextForSpeech(textToSpeak);

            if (textToSpeak.trim() === '') {
                console.warn("No text to speak.");
                return;
            }

            // Create new utterance
            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            currentUtterance.lang = 'id-ID'; // Set language to Indonesian

            // Improved voice selection for cross-device compatibility
            function setVoice() {
                if (!voicesLoaded) {
                    // On some devices, voices aren't immediately available
                    const voices = synth.getVoices();
                    if (voices.length > 0) {
                        voicesLoaded = true;
                        
                        // Try to find an Indonesian voice first
                        const idVoice = voices.find(voice => voice.lang === 'id-ID');
                        if (idVoice) {
                            currentUtterance.voice = idVoice;
                            return;
                        }
                        
                        // Fallback to any available voice
                        currentUtterance.voice = voices[0];
                    } else {
                        // If voices still not loaded, try again in 500ms
                        setTimeout(setVoice, 500);
                        return;
                    }
                }
                
                // Speak after voice is set
                synth.speak(currentUtterance);
            }

            // Event handlers
            currentUtterance.onstart = () => {
                isSpeaking = true;
                ttsBtnIcon.classList.remove('fa-volume-up');
                ttsBtnIcon.classList.add('fa-volume-mute');
            };

            currentUtterance.onend = () => {
                isSpeaking = false;
                ttsBtnIcon.classList.remove('fa-volume-mute');
                ttsBtnIcon.classList.add('fa-volume-up');
            };

            currentUtterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                isSpeaking = false;
                ttsBtnIcon.classList.remove('fa-volume-mute');
                ttsBtnIcon.classList.add('fa-volume-up');
                
                // Show user-friendly error message
                alert('Fitur text-to-speech tidak tersedia di perangkat Anda. Pastikan browser mendukung fitur ini.');
            };

            // Load voices and start speaking
            if (!voicesLoaded) {
                // Some devices need this to load voices
                synth.onvoiceschanged = setVoice;
                
                // Try to get voices immediately
                setVoice();
            } else {
                setVoice();
            }
        }

        // --- (Keep all other existing functions unchanged) ---

        document.addEventListener('DOMContentLoaded', () => {
            loadNewsDetail(); 
            loadCategoriesForDesktopNav();

            // Initialize speech synthesis voices
            if (speechSynthesis) {
                // Some devices need this to load voices
                speechSynthesis.onvoiceschanged = function() {
                    voicesLoaded = true;
                };
                
                // Try to get voices immediately
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                }
            }

            // ... (keep all other existing event listeners) ...
        });

        // ... (keep all other existing code) ...
    </script>
</body>
</html>
